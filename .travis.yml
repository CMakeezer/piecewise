sudo: required

os:
  - linux
  - osx

language:
  - cpp

arch:
  #repos:
  packages:
    # pacman packages
    - meson
    - clang
    - ninja
    # aur packages
    - lcov
  script:
    # Disable sanitizer build pending fix in kernel 4.13:
    # https://github.com/google/sanitizers/issues/856 and
    # https://github.com/google/sanitizers/issues/837
    #- CC=clang CXX=clang++ meson build/sanitizer -Db_sanitize=address
    #- meson test -C build_sanitizer
    - CC=clang CXX=clang++ meson build/clang --buildtype=release
    - meson test -C build/clang
    - CC=gcc CXX=g++ meson build/gcc --buildtype=release
    - meson test -C build/gcc
    # Disabled due to clang bug:
    # https://bugs.llvm.org//show_bug.cgi?id=33222
    #- CC=clang CXX=clang++ meson build/17/clang --buildtype=release -Dcpp_std=c++1z
    #- meson test -C build/clang
    - CC=gcc CXX=g++ meson build/17/gcc --buildtype=release -Dcpp_std=c++1z
    - meson test -C build/17/gcc
    # Unoptimized build for coverage
    - CC=gcc CXX=g++ meson build/17/coverage -Dcpp_std=c++1z -Db_coverage=true
    - meson test -C build/17/coverage
    # Generate a coverage report
    - ninja -C build/17/coverage coverage-html

before_install:
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew update; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then brew install ninja python3; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then pip3 install meson; fi

script:
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then curl -s https://raw.githubusercontent.com/mikkeloscar/arch-travis/master/arch-travis.sh | bash; fi
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then SDKROOT=$(xcodebuild -version -sdk macosx Path) mkdir build && meson build --buildtype=release && meson test -C build; fi

# Deploy coverage report to github pages
deploy:
  local_dir: $ARCH_TRAVIS_CHROOT/build/17/coverage/meson-logs/coveragereport/
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB
  on:
    branch: master
    condition: $TRAVIS_OS_NAME = linux
